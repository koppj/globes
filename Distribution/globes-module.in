#! /bin/sh
# GLoBES -- General LOng Baseline Experiment Simulator
# (C) 2002 - 2004,  The GLoBES Team
#
# GLoBES is mainly intended for academic purposes. Proper
# credit must be given if you use GLoBES or parts of it. Please
# read the section 'Credit' in the README file.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
#
# This script compiles and links modules for GLoBES, depending on the
# availability of `libtool' it uses either `libtool' or `gcc' to perform
# this task

# These come from configure
prefix=@prefix@
exec_prefix=@exec_prefix@
choice=@HAVE_LIBTOOL@
globesconf=$exec_prefix/bin/globes-config
linkage=`$globesconf --module-libs`
lt_linkage=`$globesconf --ltlibs`

usage()
{
    cat <<EOF
Usage: globes-module [source file]
    
Compiles a C/C++ file into a dynamically loadable module for GLoBES.
    
EOF
    
    exit $1
}
    
# Check wether exactly one argument has been given
if [ $# -ne "1" ]
then
    usage 1
fi


# change to working directory
cd $PWD

if [ $choice != "yes" ]
then
# No libtool ;-(
    echo
    echo "For maximally useful modules, please consider installing libtool!"
    echo

    # Call gcc to compile the program and define USE_NO_LIBTOOL
    # in order to set the names space in glb-modules.h correctly
    echo "gcc -c -g -O4 -I@includedir@ -DPIC -fPIC -DUSE_NO_LIBTOOL $1"

    gcc -c -g -O4 -I@includedir@ -DPIC -fPIC -DUSE_NO_LIBTOOL $1

    # Linking the object file with all the neccesary stuff
    echo "gcc -g -shared ${1%.c}.o $linkage -Wl,-soname -Wl,${1%.c}.so -o ${1%.c}.so"

    gcc -g -shared ${1%.c}.o $linkage\
    -Wl,-soname -Wl,${1%.c}.so -o ${1%.c}.so

else
# We have libtool
  

    # Compile the source as given on the command line
    libtool --mode=compile --tag=CC gcc -c -g -O4 -I@includedir@ $1 

    # Link the libtool-object
    libtool --mode=link --tag=CC gcc -g -o ${1%.c*}.la -rpath `pwd`\
    -no-undefined -module -avoid-version ${1%.c*}.lo \
    $lt_linkage

fi
