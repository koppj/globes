<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 7.1.2" />
<style type="text/css">
/* Debug borders */
p, li, dt, dd, div, pre, h1, h2, h3, h4, h5, h6 {
/*
  border: 1px solid red;
*/
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
}

strong {
  font-weight: bold;
}

tt {
  color: navy;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  font-family: sans-serif;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1 {
  border-bottom: 2px solid silver;
}
h2 {
  border-bottom: 2px solid silver;
  padding-top: 0.5em;
}

div.sectionbody {
  font-family: serif;
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

pre {
  padding: 0;
  margin: 0;
}

span#author {
  color: #527bbd;
  font-family: sans-serif;
  font-weight: bold;
  font-size: 1.2em;
}
span#email {
}
span#revision {
  font-family: sans-serif;
}

div#footer {
  font-family: sans-serif;
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
div#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
div#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

div#preamble,
div.tableblock, div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-right: 10%;
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.5em;
  margin-bottom: 2.5em;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  font-family: sans-serif;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid silver;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid silver;
  background: #f4f4f4;
  padding: 0.5em;
}

div.quoteblock > div.content {
  padding-left: 2.0em;
}

div.attribution {
  text-align: right;
}
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 2px solid silver;
}

div.exampleblock > div.content {
  border-left: 2px solid silver;
  padding: 0.5em;
}

div.verseblock div.content {
  white-space: pre;
}

div.imageblock div.content { padding-left: 0; }
div.imageblock img { border: 1px solid silver; }
span.image img { border-style: none; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: italic;
}
dd > *:first-child {
  margin-top: 0;
}

ul, ol {
    list-style-position: outside;
}
ol.olist2 {
  list-style-type: lower-alpha;
}

div.tableblock > table {
  border: 3px solid #527bbd;
}
thead {
  font-family: sans-serif;
  font-weight: bold;
}
tfoot {
  font-weight: bold;
}

div.hlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
td.hlist1 {
  vertical-align: top;
  font-style: italic;
  padding-right: 0.8em;
}
td.hlist2 {
  vertical-align: top;
}

@media print {
  div#footer-badges { display: none; }
}
/* Workarounds for IE6's broken and incomplete CSS2. */

div.sidebar-content {
  background: #ffffee;
  border: 1px solid silver;
  padding: 0.5em;
}
div.sidebar-title, div.image-title {
  font-family: sans-serif;
  font-weight: bold;
  margin-top: 0.0em;
  margin-bottom: 0.5em;
}

div.listingblock div.content {
  border: 1px solid silver;
  background: #f4f4f4;
  padding: 0.5em;
}

div.quoteblock-content {
  padding-left: 2.0em;
}

div.exampleblock-content {
  border-left: 2px solid silver;
  padding-left: 0.5em;
}
</style>
</head>
<body>
<div id="header">
</div>
<h2>GLoBES transition from CVS to git</h2>
<div class="sectionbody">
<p>Patrick Huber</p>
<p><tt>git</tt> is a so called distributed source code management system (SCM),
whereas <tt>CVS</tt> is a centralized SCM. There are nearly religious-like
view points on the merits and drawback of the distributed versus
centralized approach. It is, however, clear, that in practice none of
the approaches is used in a pure fashion. In a centralized world you
often do have private working copies which never get commited to the
central server. Sometimes you do send a patch by email instead going
via the central repo. In a distributed world, some centralization is
necessary otherwise, N developers would have to do N<sup>2</sup> updates to
ensure everyone has the same state of repo. Important about using a
distributed SCM is that it allows to work in a centralized fashion,
but it does not force you to. The notion of central repository becomes
a social one and is no longer a technical one. For <tt>GLoBES</tt> we want to
keep one central repo in Heidelberg.</p>
<p>With <tt>git</tt> every developer will have a fully equipped local copy of
the repo. This allows to do very fast, since fully local,
operations. Especially commits, diffs, branches and log searches
become very fats and easy operations, which also work while working
offline. Besides, your commit initially stay private, hence it is
possible to commit incrementally, one change at a time. This makes log
messages and the whole history much more useful. It also makes it
easier to follow the work of other people. Cheap branches allow to
test new things on a temporary branch. If it works it will get merged
into the mainline of development, if not the branch will be deleted.
Eventually the local repo is synchronized with the central repo, but only once your ready and the code is again in a workable state.</p>
<p><tt>git</tt> does not track files, it tracks the content of files. This a
fine, but in practice important difference. This allows to move and
rename files while preserving their history. We had those renames in
the past and we did disconnect the history of files in that way.</p>
<p>This short document tries to describe the very minimal set of things
to know about <tt>git</tt> in order to allow for a smooth transition from
<tt>CVS</tt> to <tt>git</tt>. All the commands in here, I have actually tried out
with version 1.5.3 of <tt>git</tt> and an actual copy of the <tt>GLoBES</tt> CVS
repository (imported into <tt>git</tt>).</p>
<p>There is an <a href="RM.html">accompanying document</a>, which described how
the actual moving will work. It also describes who the release
management, version numbering etc. are planed to work after the
move. Hence anyone involved in making the actual release and/or
writing code is encouraged to read that as well.</p>
</div>
<h2>Local git repos for developers</h2>
<div class="sectionbody">
<p>You get a local copy:</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ git-clone ssh://phuber@login/~/globes-git-central globes-bob/</tt></pre>
</div></div>
<p>Took about 8 minutes from Wisconsin to CERN and creates about 300MB
stuff on your hard drive. Everything seems to be in order&#8230;</p>
<p>globes-3.0.11 builds out of the box</p>
<p>run locally, i.e. inside <tt>globes-bob</tt></p>
<div class="listingblock">
<div class="content">
<pre><tt>$ git config user.name "Bob Bar"
$ git config user.email "bob@bar.com"</tt></pre>
</div></div>
<p>This creates in <tt>.git/config</tt></p>
<div class="listingblock">
<div class="content">
<pre><tt>[user]
        name  = "bob"
        email = "bob@bar.com"</tt></pre>
</div></div>
<p>I highly recommend the everyone does that in his/her local copy (of
course use your real name). In that way, although we only have one
account, we preserve the correct authorship. That is highly useful for
tools like <tt>git-blame</tt>.</p>
</div>
<h2>Typical CVS-like usage</h2>
<div class="sectionbody">
<h3>Dictionary</h3>
<p>If you just want to pretend that you`re still using CVS</p>
<div class="tableblock">
<table rules="none"
frame="hsides"
cellspacing="0" cellpadding="4">
<col width="182" />
<col width="285" />
<tbody valign="top">
  <tr>
    <td align="left">
    cvs update
    </td>
    <td align="left">
    git pull
    </td>
  </tr>
  <tr>
    <td align="left">
    cvs commit
    </td>
    <td align="left">
    git commit -a &amp; git push
    </td>
  </tr>
  <tr>
    <td align="left">
    cvs add
    </td>
    <td align="left">
    git add
    </td>
  </tr>
  <tr>
    <td align="left">
    cvs rm
    </td>
    <td align="left">
    git rm
    </td>
  </tr>
  <tr>
    <td align="left">
    cvs checkout
    </td>
    <td align="left">
    git clone
    </td>
  </tr>
  <tr>
    <td align="left">
    cvs diff
    </td>
    <td align="left">
    git diff
    </td>
  </tr>
  <tr>
    <td align="left">
    cvs log
    </td>
    <td align="left">
    git log
    </td>
  </tr>
  <tr>
    <td align="left">
    cvs tag
    </td>
    <td align="left">
    git tag
    </td>
  </tr>
</tbody>
</table>
</div>
<h3>Added functionality</h3>
<p>You will have noticed that the equivalent of <tt>cvs commit</tt> are indeed
to commands in git. The reason is, that you have a fully equipped local
repository and hence all git commands (with 3 exceptions) will operate
on that local copy only. This is great for speed, if you`re offline or
if you screw up. Since <tt>git commit</tt> operates on your local repo you
can actually revert a commit. Also commits are fast, that encourages
to make small commits, i.e.you just commit at once those changes which
actually belong together. Even if the resulting code in the repo won`t
compile. That bothers nobody, since it is in your local repo
only. Then you keep commiting stuff, up to the point where you have
fully working code again. Now, and only now, you decide to push your
stuff into the central repo. Thus <tt>git push</tt> is one of the three
exceptions, once your commits are pushed it is very hard to correct
them. The other exception is <tt>git pull</tt>, which gets all changes from
the central repo <strong>and</strong> merges them. If you just want to see the
changes but nor merge them use <tt>git fetch</tt> and later <tt>git merge</tt>. Thus
<tt>git fetch</tt> is the 3rd exception.</p>
<h3>Pitfalls</h3>
<p><tt>git add</tt> adds not a file but a current snapshot of the file to the
repo, hence you should commit immediately afterward, or later changes
to that file will get lost.</p>
</div>
<h2>Fixing conflicts</h2>
<div class="sectionbody">
<p>Conflict between Bob and Alice</p>
<dl>
<dt>
Bob
</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre><tt>(edit glb_error.c)
$ git commit -a
$ git push</tt></pre>
</div></div>
</dd>
<dt>
Alice
</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre><tt>(edit glb_error.c)
$ git commit -a
$ git push</tt></pre>
</div></div>
</dd>
</dl>
<p>Anyway you may want to <tt>git pull</tt> before you do <tt>git push</tt>!</p>
<dl>
<dt>
Alice gets
</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre><tt>...
CONFLICT (content): Merge conflict in Distribution/source/glb_error.c
Automatic merge failed; fix conflicts and then commit the result.</tt></pre>
</div></div>
</dd>
</dl>
<p>and inside glb_error.c we find:</p>
<div class="listingblock">
<div class="content">
<pre><tt>void
glb_fatal (const char *message)
{
  /* A FATAL message always is displayed */
&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD:Distribution/source/glb_error.c
  error (EXIT_FAILURE, "BOB-2", message,1);
=======
  error (EXIT_FAILURE, "Alice-2", message,1);
&gt;&gt;&gt;&gt;&gt;&gt;&gt; ac3a3ba4ca60432429b5dc8e2fda64f21cc96c94:Distribution/source/glb_error.c
}</tt></pre>
</div></div>
<p>i.e. that looks like CVS. Now we fix that, and then one has to do</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ git add glb_error.c</tt></pre>
</div></div>
<p>which add a current snapshot of <tt>glb_error.c</tt> to the things which are
going to be commited.</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ git commit -a</tt></pre>
</div></div>
<p>just leave the automatic commit message.  It will tell you a lot
about merge and blabla, just ignore and finally (maybe later) git push</p>
<dl>
<dt>
Alice
</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre><tt>$ git pull</tt></pre>
</div></div>
</dd>
</dl>
<p>and all is fine</p>
</div>
<h2>Local branches</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre><tt>$ git branch test</tt></pre>
</div></div>
<p>creates branch test</p>
<div class="literalblock">
<div class="content">
<pre><tt>       o- test
      /
-o-o-o-o-o-o-o master</tt></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><tt>$ git checkout test</tt></pre>
</div></div>
<p>switch to branch test, now your <tt>test</tt> is the active branch, which you
can check with</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ git branch
  master
  test *
(edit glb_error.c)
$ git commit -a
(edit glb_error.c)</tt></pre>
</div></div>
<p>and try to switch back to master</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ git checkout master
  fatal: Entry 'Distribution/source/glb_error.c' not uptodate. Cannot merge.</tt></pre>
</div></div>
<p>Now let`s commit our changes and make <tt>glb_error.c</tt> uptodate.</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ git commit -a
$ git checkout master</tt></pre>
</div></div>
<p>OK.</p>
<p>Now the structure looks like</p>
<div class="literalblock">
<div class="content">
<pre><tt>       o-o-o test
      /
-o-o-o-o-o-o-o master</tt></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><tt>$ git pull . test</tt></pre>
</div></div>
<p>now we have</p>
<div class="literalblock">
<div class="content">
<pre><tt>       o-o-o test
      /     \
-o-o-o-o-o-o-o master</tt></pre>
</div></div>
<p>will merge test into master.</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ git branch -d test</tt></pre>
</div></div>
<p>deletes the fully merged branch.</p>
<p>after that we</p>
<div class="literalblock">
<div class="content">
<pre><tt>       o-o-o
      /     \
-o-o-o-o-o-o-o-o-o master</tt></pre>
</div></div>
<p>If we wouldn`t have deleted test we`d still could add new things to
test and merge them later, like this</p>
<div class="literalblock">
<div class="content">
<pre><tt> test  o-o-o-o-o-o-o
      /     \
-o-o-o-o-o-o-o-o-o-o-o- master</tt></pre>
</div></div>
<p>and one can continue merging, back and forth.</p>
<p>The idea is that local branches are cheap and hence a great way to try
things without messing up anything. If all goes wrong delete the
branch without ever merging it. That may require using the <tt>-D</tt> option
to <tt>git branch</tt>. On the other hand if your happy with your bugfix,
cool new feature, whatever, then you just merge your temporary tree
and delete it. Now you can push your stuff into the central repo.</p>
</div>
<h2>Remote branch creation and tracking</h2>
<div class="sectionbody">
<p>Sometimes, however we will want new public branches, to e.g. share the
development of new experimental features or when there is a release,
since that code should go into its own branch.</p>
<p>Bob wants to collaborator on the <em>write-paper</em> feature, thus he
creates a feature branch <tt>feature-write-paper</tt> branching from the
current <tt>master</tt>.</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ git checkout -b feature-write-paper master</tt></pre>
</div></div>
<p>this also switches to that branch.</p>
<p>Now we have</p>
<div class="literalblock">
<div class="content">
<pre><tt>         --        feature-write-paper
        /
-o-o-o-o-o-o-o-o-  master</tt></pre>
</div></div>
<p>Next we need to make that public. First we push our new branch</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ git push origin feature-write-paper</tt></pre>
</div></div>
<p>Next we need to ensure that Bob gets all the cool stuff his
collaborators develop on that branch.</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ git config branch.feature-write-paper.remote origin
$ git config branch.feature-write-paper.merge refs/heads/feature-write-paper</tt></pre>
</div></div>
<p>These are the same things</p>
<div class="listingblock">
<div class="content">
<pre><tt>$ git branch --track feature-write-paper origin/feature-write-paper</tt></pre>
</div></div>
<p>would create, but Bob has that branch already.</p>
<dl>
<dt>
Alice
</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre><tt>$ git fetch
$ git branch -r</tt></pre>
</div></div>
</dd>
</dl>
<p>will show the new branch created by Bob. Alice decides to work on that
branch to implement the <em>auto-conclusion</em> module.</p>
<dl>
<dt>
Alice
</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre><tt>$ git branch --track feature-write-paper origin/feature-write-paper
$ git checkout feature-write-paper</tt></pre>
</div></div>
</dd>
<dt>
Alice
</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre><tt>(creates blue.c in Distribution/source)
$ git add blue.c
$ git commit blue.c -m "blue.c added"
$ git push</tt></pre>
</div></div>
</dd>
<dt>
Bob
</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre><tt>$ git pull</tt></pre>
</div></div>
</dd>
</dl>
<p>and he get's Alice's changed <tt>feature-write-paper</tt> branch.</p>
<h3>Branch structure</h3>
<div class="literalblock">
<div class="content">
<pre><tt>         o-o-o-o-o-o-o-o-o-o-o-o-o feature-write-paper  shared by Bob &amp; Alice
        /                       \
       /                         \ merge to master once auto-conclusion works
      /                           \
-o-o-o-o-o-o-o-o-o-o-o-o-o-o-o-o-o-o- master</tt></pre>
</div></div>
<p>Once the <em>auto-conclusion</em> stuff work we want to merge that into
<tt>master</tt></p>
<div class="listingblock">
<div class="content">
<pre><tt>$ git checkout master
$ git pull . feature-write-paper</tt></pre>
</div></div>
<p>which would try to merge all unmerged changes. Sometimes a more
careful selection might be necessary, using <tt>git cherrypick</tt>.</p>
<h3>Summary</h3>
<p>Creating, deleting, switching, merging branches locally is very
easy. Sharing branches via a central repository seems to work (we`ll
see how they cope with merges asf.) but it is not totally
straightforward and basically not documented. It took me a day&#8230; I
guess that reflects how the kernel development works, where the model
is <tt>Linus pulls</tt>. However, I think for globes we`d like to have this
centralized model. Especially, since I`d like to be able to share
development of new features in an early stage to get feedback.</p>
</div>
<h2>CVS emulation &#8212; is broken</h2>
<div class="sectionbody">
<p>Edit the config file in the central repository by adding, which allows
cvs access via ssh put not pserver</p>
<div class="listingblock">
<div class="content">
<pre><tt>[gitcvs]
        enabled=0

[gitcvs "ext"]
        enabled=1</tt></pre>
</div></div>
<ul>
<li>
<p>
git needs to be installed, for those who want to use CVS access
</p>
</li>
</ul>
<div class="listingblock">
<div class="content">
<pre><tt>$ cvs -d ":ext;CVS_SERVER=git-cvsserver:phuber@login/afs/hep.wisc.edu/home/phuber/globes-git-central/.git" co master
</tt></pre>
</div></div>
<p>Two peculiarities of this one:</p>
<ul>
<li>
<p>
needs the full path to the git repo
</p>
</li>
<li>
<p>
secondly one has to checkout master (instead of a real CVS module,
but after a bit of thinking this makes sens)
</p>
</li>
</ul>
<p>Otherwise seems to work fine. (took 6 minutes or so).</p>
<p>All the stuff ended up in a directory named "master" (usual cvs
behaviour), I rename that to globes-cvs</p>
<dl>
<dt>
CVS-guy
</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre><tt>(edits glb_error.c)
$ cvs ci
  cvs commit: Examining .
  phuber@login.hep.wisc.edu's password:
  Index already exists in git repo
  cvs commit: saving log message in /tmp/cvs58x89o</tt></pre>
</div></div>
</dd>
</dl>
<p>doesn't work even with new versions&#8230;</p>
</div>
<div id="footer">
<div id="footer-text">
Last updated 25-Oct-2007 12:15:42 CEST
</div>
</div>
</body>
</html>
